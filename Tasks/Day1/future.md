'USE STRICT';

CONST FS = REQUIRE('NODE:FS');

CLASS FUTURE {
  CONSTRUCTOR(COMPUTATION) {
    THIS.FORK = COMPUTATION;
  }

  MAP(FN) {
    RETURN NEW FUTURE((REJECT, RESOLVE) =>
      THIS.FORK(REJECT, (VALUE) => RESOLVE(FN(VALUE))),
    );
  }

  CHAIN(FN) {
    RETURN NEW FUTURE((REJECT, RESOLVE) =>
      THIS.FORK(
        REJECT,
        (VALUE) => FN(VALUE).FORK(REJECT, RESOLVE),
      ),
    );
  }
}

CONST FUTURIFY = (FN) =>
  (...ARGS) =>
    NEW FUTURE((REJECT, RESOLVE) =>
      FN(...ARGS, (ERROR, RESULT) =>
        ERROR ? REJECT(ERROR) : RESOLVE(RESULT),
      ),
    );

CONST READFUTURE = FUTURIFY(FS.READFILE);
CONST WRITEFUTURE = FUTURIFY(FS.WRITEFILE);

READFUTURE('5-FUTURE.JS', 'UTF8')
  .MAP((TEXT) => TEXT.TOUPPERCASE())
  .CHAIN((TEXT) => WRITEFUTURE('FUTURE.MD', TEXT))
  .FORK(
    (ERROR) => CONSOLE.ERROR('FS ERROR:', ERROR),
    () => CONSOLE.LOG('DONE'),
  );
